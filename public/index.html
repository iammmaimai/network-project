<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous"
    />
    <link rel="stylesheet" href="css/style.css" />
    <title>ChatCord App</title>
</head>
<body class="join-page">
    <div class="join-container">
        <header class="join-header">
            <h1><i class="fas fa-smile"></i> ChatCord</h1>
        </header>
        <main class="join-main">
            <form action="chat.html" id="join-form">
                <div class="form-control">
                    <label for="username">Username</label>
                    <input
                        type="text"
                        name="username"
                        id="username"
                        placeholder="Enter username..."
                        required
                    />
                </div>
                
                <div class="form-control">
                    <label for="room">Room Name</label>
                    <input
                        type="text"
                        name="room"
                        id="room"
                        placeholder="Type new room or select below..."
                        required
                        autocomplete="off"
                    />
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <i class="fas fa-info-circle"></i> Type any name to create a new room
                    </small>
                </div>

                <div class="available-rooms">
                    <h4><i class="fas fa-door-open"></i> Active Rooms</h4>
                    <div id="rooms-list" class="rooms-grid">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Loading rooms...
                        </div>
                    </div>
                </div>

                <div class="available-rooms">
                    <h4><i class="fas fa-users-cog"></i> Available Groups</h4>
                    <div id="groups-list" class="rooms-grid">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Loading groups...
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Join Chat
                </button>
            </form>
        </main>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Connect to socket to get active rooms and groups
        const socket = io();
        const roomInput = document.getElementById('room');
        const roomsList = document.getElementById('rooms-list');
        const groupsList = document.getElementById('groups-list');
        
        let activeRooms = new Map();
        let availableGroups = [];

        // Request initial data
        socket.emit('getActiveRooms');
        socket.emit('getAllGroups');

        // Receive active rooms with user counts
        socket.on('activeRooms', (rooms) => {
            activeRooms = new Map(Object.entries(rooms));
            displayRooms();
        });

        // Receive available groups
        socket.on('allGroupsList', (groups) => {
            availableGroups = groups;
            displayGroups();
        });

        // Display active rooms
        function displayRooms() {
            if (activeRooms.size === 0) {
                roomsList.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i> No active rooms</div>';
                return;
            }

            roomsList.innerHTML = '';
            activeRooms.forEach((count, roomName) => {
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card';
                roomCard.innerHTML = `
                    <div class="room-icon">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="room-info">
                        <div class="room-name">${roomName}</div>
                        <div class="room-count">
                            <i class="fas fa-users"></i> ${count} online
                        </div>
                    </div>
                `;
                
                roomCard.addEventListener('click', () => {
                    roomInput.value = roomName;
                    roomInput.focus();
                    
                    // Remove active class from all cards
                    document.querySelectorAll('.room-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    document.querySelectorAll('.group-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    
                    // Add active class to clicked card
                    roomCard.classList.add('active');
                });
                
                roomsList.appendChild(roomCard);
            });
        }

        // Display available groups
        function displayGroups() {
            if (availableGroups.length === 0) {
                groupsList.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i> No groups yet</div>';
                return;
            }

            groupsList.innerHTML = '';
            availableGroups.forEach(group => {
                const groupCard = document.createElement('div');
                groupCard.className = 'group-card';
                groupCard.innerHTML = `
                    <div class="room-icon group-icon">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="room-info">
                        <div class="room-name">${group.name}</div>
                        <div class="room-count">
                            <i class="fas fa-user"></i> ${group.creator.username} â€¢ 
                            <i class="fas fa-users"></i> ${group.members.length}
                        </div>
                    </div>
                `;
                
                groupCard.addEventListener('click', () => {
                    roomInput.value = group.name;
                    roomInput.focus();
                    
                    // Remove active class from all cards
                    document.querySelectorAll('.room-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    document.querySelectorAll('.group-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    
                    // Add active class to clicked card
                    groupCard.classList.add('active');
                });
                
                groupsList.appendChild(groupCard);
            });
        }

        // Clear selection when typing
        roomInput.addEventListener('input', () => {
            document.querySelectorAll('.room-card, .group-card').forEach(card => {
                card.classList.remove('active');
            });
        });

        // Refresh data periodically
        setInterval(() => {
            socket.emit('getActiveRooms');
            socket.emit('getAllGroups');
        }, 5000);
    </script>
</body>
</html>